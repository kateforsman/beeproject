---
title: "Untitled"
output: html_document
date: "2024-11-13"
---

```{r setup, include=FALSE}
# packages that will be used
library(sf)
library(terra) 
library(ggplot2)
library(dplyr)
library(ggspatial)
library(tmap)
library(RColorBrewer)
library(raster)
```





```{r - Random stuff that may be useful later}
#gdb_file <- "C:/Users/Admin/Downloads/OR_DEM_10M.gdb/OR_DEM_10M.gdb/a00000029.gdbtable"
#layers <- st_layers(gdb_file)
#print(layers)

#gdb_data <- st_read(dsn = gdb_file, layer = "fras_blk_DEM_10meter_Oregon")


#head(gdb_data)


```





```{r - Code for reading in a reducing resolution of DEM data}

describe("C:/Users/Admin/Downloads/OR_DEM_10M_files.gdb")
dem_rast <- rast("C:/Users/Admin/Downloads/OR_DEM_10M_files.gdb")
dem_rast

dem_rast_downsampled <- aggregate(dem_rast, fact = 100, fun = mean)
dem_rast_dsamp_df <- as.data.frame(dem_rast_downsampled, xy = TRUE)

head(dem_rast_dsamp_df)
summary(values(dem_rast_downsampled))

```




```{r Reading in ecoregion data and plot of elevation and ecoregions}

ecoregions_vec <- st_read("C:/Users/Admin/Downloads/ds-environ-JS/5-lab-OR-fires/5-OR-fires/OR-ecoregions/Ecoregions_OregonConservationStrategy.shp")
head(ecoregions_vec)

crs(ecoregions_vec, proj = TRUE)
crs(dem_rast_downsampled, proj = TRUE)

# changing ecoregion crs to dem crs
ecoregions <- st_transform(ecoregions_vec, crs(dem_rast))


elevation_all_ecoregions_plot <- ggplot() +
  geom_raster(data = dem_rast_dsamp_df, aes(x = x, y = y, fill = OR_DEM_10M_files)) +
  scale_fill_viridis_c() +
  geom_sf(data = ecoregions, color = "white", fill = NA) 

elevation_all_ecoregions_plot

```

```{r getting rid of na values and cleaning coordinates to only OR entries}

OBA <- read.csv("C:/Users/Admin/Downloads/ds-environ-JS/6_lab_OBA_spatial/6_OBA_spatial/OBA_2018-2023.csv")
head(OBA)
names(OBA)

OBA_filtered <- OBA %>% 
  dplyr::select("Dec..Lat." , "Dec..Long.", "Species", "State") %>%
  rename(Latitude = Dec..Lat., Longitude = Dec..Long.) %>%
  filter(!is.na(Species) & Species != "") %>%
  dplyr::select("Latitude" , "Longitude", "Species", "State")

OBA_filtered


head(OBA_filtered)

OBA_clean <- OBA_filtered %>%
  filter(!is.na(Longitude) & !is.na(Latitude)) %>%
  filter(Longitude > -125 & Longitude < -116.5 & Latitude > -47 & Latitude < 47) %>%
  filter(Latitude != 39.98700) %>%
  filter(Latitude != 46.99) %>%
  filter(Longitude != -125.3831) %>%
  filter(Latitude != 41.680) %>%
  filter(Longitude != -116.464) %>%
  filter(State %in% c("Oregon ", "Oregon", "OR"))

head(OBA_clean)

OBA_sf <- st_as_sf(OBA_clean,
                          coords = c("Longitude","Latitude"),
                          crs = crs("EPSG:4326"))
head(OBA_sf)

OBA_sf

OBA_reprojected <- st_transform(OBA_sf, crs(dem_rast))

class(OBA_reprojected)

```

```{r Filling out OBA df with elevation and ecoregion for each bee observation}

# basically adding elevation column to oba data
OBA_reprojected$Elevation <- terra::extract(dem_rast_downsampled, OBA_reprojected, ID = FALSE)[[1]]

hist(OBA_reprojected$Elevation)


# adding ecoregion column to oba data
template <- rast(vect(ecoregions), res = res(dem_rast_downsampled))

rast_ecoregions <- rasterize(vect(ecoregions), template, field = "Ecoregion")

OBA_reprojected$Ecoregion <- terra::extract(rast_ecoregions, OBA_reprojected, ID = FALSE)[[1]]

OBA_reprojected
plot(rast_ecoregions)
table(OBA_reprojected$Ecoregion)


# turning reprojected OBA data into df
OBA_reprojected_df <- as.data.frame(OBA_reprojected, xy=TRUE)
class(OBA_reprojected_df)


# adding in elevation bins - seems like this method doesn't work quite right
# since the border issues cause the ecoregions touching the edge of the 
# OBA_reprojected_df <- OBA_reprojected_df %>%
#   group_by(Ecoregion) %>%
#   mutate(
#     ElevationBin = cut(
#       Elevation, 
#       breaks = seq(min(Elevation), max(Elevation), length.out = 11), include.lowest = TRUE))


# this binning method works but sometimes gives 11 bins instead of 10 
OBA_reprojected_wBreaks <- OBA_reprojected %>%
  group_by(Ecoregion) %>%
  mutate(
    ElevationBin = cut(
      Elevation, 
      breaks = 4,
      include.lowest = TRUE))

OBA_reprojected_wBreaks <- as.data.frame(OBA_reprojected_wBreaks)

OBA_reprojected_wBreaks





 
# removing NA elevation bins
OBA_reprojected_wBreaks_clean <- OBA_reprojected_wBreaks %>%
  filter(!is.na(ElevationBin)) %>% 
  filter(!is.na(Ecoregion)) %>% 
  filter(Ecoregion != "Nearshore")



# # Check the cleaned dataset
# (OBA_reprojected_wBreaks_clean)
# 
# sum(is.na(OBA_reprojected_wBreaks_clean$ElevationBin))
# 
# length(unique(OBA_reprojected_wBreaks_clean$ElevationBin[OBA_reprojected_wBreaks_clean$Ecoregion == "Nearshore"]))
# 
# range(OBA_reprojected_wBreaks_clean$Elevation)
# 
# levels(ElevationBin)

# shuffle elevation bins - identity of species varies randomly
# take observed # of species in elevation bin and subtract generated #
# tvd is sum abs(obs - expected) /2 

#shuffle elevation bins

# splits data into separate ecoregions

OBA_reprojected_wBreaks_clean$Ecoregion <- as.character(OBA_reprojected_wBreaks_clean$Ecoregion)

# splitting to create list of data frames, each containing information for an ecoregion
sp_occ <- split(OBA_reprojected_wBreaks_clean, OBA_reprojected_wBreaks_clean$Ecoregion)
sp_occ
shuffled_sp_occ <- list()

names(shuffled_sp_occ) <- names(sp_occ)


calc_tvd <- function(observed, null) {

  observed_dist <- observed / sum(observed) 
  null_dist <- null / sum(null)             
  tvd <- 0.5 * sum(abs(observed_dist - null_dist))
  return(tvd)
}

calculate_tvd_all_ecoregions <- function(shuffled_sp_occ, observed=FALSE) {
  totalV <- list()
  if(observed == TRUE){
    for(ecoreg in 1:length(shuffled_sp_occ)){
    observed_richness <- shuffled_sp_occ[[ecoreg]] %>%
      group_by(ElevationBin) %>%
      summarize(
        BeeSpeciesRichness = length(unique(Species)))
    totalV[[ecoreg]] <- calc_tvd(observed_richness$BeeSpeciesRichness, rep(0.25, length(observed_richness$BeeSpeciesRichness)))
    }
    names(totalV) <- names(shuffled_sp_occ)
    totalV <- unlist(totalV, recursive=FALSE)
  }else{
    print("here")
    for(i in 1:length(shuffled_sp_occ)){
      generated_richness <- shuffled_sp_occ[[i]] %>%
        group_by(shuffled_ElevationBin) %>%
        summarize(
          shuffled_BeeSpeciesRichness = length(unique(Species)))
      #  colnames(generated_richness) <- c("ElevationBin", "shuffled_BeeSpeciesRichness")
      # total_richness <- left_join(observed_richness, generated_richness)
      
      totalV[[i]] <- calc_tvd(generated_richness$shuffled_BeeSpeciesRichness, 
                              rep(0.25, length(total_richness$shuffled_BeeSpeciesRichness)))
    }
    names(totalV) <- names(shuffled_sp_occ)
    totalV <- unlist(totalV, recursive = FALSE)
  }
  return(totalV)
}

calculate_tvd_all_ecoregions(shuffled_sp_occ)
observed_values <- calculate_tvd_all_ecoregions(shuffled_sp_occ, observed=TRUE)

names(shuffled_sp_occ)
shuffled_sp_occ
#   return(totalV)
# }
# observed_tvd <- calculate_tvd_all_ecoregions(shuffled_sp_occ)
# observed_tvd 


# names(total_richness) <- names(shuffled_sp_occ)
# total_richness["Willamette Valley"]
# 
# 
# names(shuffled_sp_occ) <- names(sp_occ)
# 
# # df for each ecoregion - has shuffled and normal elevation bins
# shuffled_sp_occ
# shuffled_sp_occ[["Coast Range"]]
# sp_occ[["Nearshore"]]
# names(shuffled_sp_occ)

# shuffled_Elevation <- sample(OBA_reprojected_wBreaks_clean$ElevationBin, nrow(OBA_reprojected_wBreaks_clean), replace = FALSE)
# OBA_reprojected_wBreaks_clean$shuffled_ElevationBin <- shuffled_Elevation
# 
# OBA_reprojected_wBreaks_clean



```



```{r Null distribution generation - maybe works???}



# Initialize list to store null distributions for each ecoregion


# Number of repetitions
reps <- 100
null_distributions <- matrix(NA, nrow=reps, ncol=length(sp_occ))
colnames(null_distributions) <- names(sp_occ)

for(i in 1:reps){
  shuffled_sp_occ <- list()
  for(n in 1:length(sp_occ)){
    shuffled_column <- sample(sp_occ[[n]]$ElevationBin, nrow(sp_occ[[n]]), replace = FALSE)
    new_sp_occ <- sp_occ[[n]]
    new_sp_occ$shuffled_ElevationBin <- shuffled_column
    shuffled_sp_occ[[n]] <- new_sp_occ
  }
  names(shuffled_sp_occ) <- names(sp_occ)
  null_distributions[i,] <- calculate_tvd_all_ecoregions(shuffled_sp_occ) 
  
}
rownames(null_distributions)

calculate_tvd_all_ecoregions(sp_occ) 
calculate_tvd_all_ecoregions(sp_occ, observed=TRUE) 


# # Loop through each ecoregion
# for (i in 1:length(sp_occ)) {
#   null_tvd <- numeric(reps) # Vector to store TVD values for repetitions
#   
#   for (j in 1:reps) {
#     # Shuffle the ElevationBin
#     shuffled_column <- sample(sp_occ[[i]]$ElevationBin, nrow(sp_occ[[i]]), replace = FALSE)
#     new_sp_occ <- sp_occ[[i]]
#     new_sp_occ$shuffled_ElevationBin <- shuffled_column
#     
#     # Calculate observed and shuffled richness
#     observed_richness <- new_sp_occ %>%
#       group_by(ElevationBin) %>%
#       summarize(BeeSpeciesRichness = length(unique(Species)))
#     
#     generated_richness <- new_sp_occ %>%
#       group_by(shuffled_ElevationBin) %>%
#       summarize(shuffled_BeeSpeciesRichness = length(unique(Species)))
#     
#     colnames(generated_richness) <- c("ElevationBin", "shuffled_BeeSpeciesRichness")
#     total_richness <- left_join(observed_richness, generated_richness)
#     
#     # Calculate TVD and store it
#     null_tvd[j] <- calc_tvd(total_richness$BeeSpeciesRichness, total_richness$shuffled_BeeSpeciesRichness)
#   }
#   
#   # Store the null distribution for this ecoregion
#   null_distributions[[names(sp_occ)[i]]] <- null_tvd
# }
# 
# # Combine all null distributions into a single data frame for plotting
# null_dist_df <- do.call(rbind, lapply(names(null_distributions), function(ecoregion) {
#   data.frame(
#     Ecoregion = ecoregion,
#     TVD = null_distributions[[ecoregion]]
#   )
# }))
# 
# # Create a data frame for observed TVD values
# observed_tvd_df <- data.frame(
#   Ecoregion = names(totalV),
#   ObservedTVD = unlist(totalV)
# )
# 
# # Merge observed TVD with null distributions
# null_dist_with_obs <- merge(null_dist_df, observed_tvd_df, by = "Ecoregion")
# 
# # Calculate p-values
# p_values <- null_dist_with_obs %>%
#   group_by(Ecoregion) %>%
#   summarize(
#     ObservedTVD = first(ObservedTVD),
#     PValue = mean(TVD >= ObservedTVD)
#   )
# 
# # Plot histograms with observed TVD lines
# histogram_plot <- ggplot(null_dist_with_obs, aes(x = TVD, fill = Ecoregion)) +
#   geom_histogram(alpha = 0.6, bins = 30, position = "identity") +
#   geom_vline(data = p_values, aes(xintercept = ObservedTVD, color = Ecoregion), linewidth = 1, color = "black") +
#   facet_wrap(~ Ecoregion, scales = "free") +
#   labs(
#     title = "Null Distributions of TVD by Ecoregion with Observed TVD Lines",
#     x = "TVD",
#     y = "Frequency"
#   ) +
#   theme_minimal() +
#   theme(legend.position = "none")
# 
# histogram_plot
# 
# p_values


new_hist <- ggplot() +
  geom_histogram(null_distributions, aes(x=nrow(null_distributions))) +
  geom_vline(observed_values)

```





```{r}

Elevation_Richness <- sp_occ %>%
  group_by(ElevationBin, Ecoregion) %>%
  summarize(
    BeeSpeciesRichness= length(unique(Species)))



shuffled_Elevation_Richness <- shuffled_sp_occ %>%
  group_by(shuffled_ElevationBin, Ecoregion) %>%
  summarize(
    BeeSpeciesRichness= length(unique(Species)))

Elevation_Richness

shuffled_Elevation_Richness


```



---
title: "Untitled"
output: html_document
date: "2024-11-13"
---

```{r setup, include=FALSE}
# packages that will be used
library(sf)
library(terra) 
library(ggplot2)
library(dplyr)
library(ggspatial)
library(tmap)
library(RColorBrewer)
library(raster)
```
  


```{r - Code for reading in and reducing resolution of DEM data}

describe("dem_rast_r.tif")
dem_rast <- rast("dem_rast_r.tif")
dem_rast

dem_rast_downsampled <- aggregate(dem_rast, fact = 100, fun = mean)
dem_rast_dsamp_df <- as.data.frame(dem_rast_downsampled, xy = TRUE)

# initial data exploration of DEM
head(dem_rast_dsamp_df)
summary(values(dem_rast_downsampled))

```



```{r Reading in ecoregion data and plot of elevation and ecoregions}

ecoregions_vec <- st_read("OR-ecoregions")
head(ecoregions_vec)

crs(ecoregions_vec, proj = TRUE)
crs(dem_rast_downsampled, proj = TRUE)

# changing ecoregion crs to dem crs
ecoregions <- st_transform(ecoregions_vec, crs(dem_rast))

# cool plot of elevation and ecoregion data together
elevation_all_ecoregions_plot <- ggplot() +
  geom_raster(data = dem_rast_dsamp_df, aes(x = x, y = y, fill = OR_DEM_10M_files)) +
  scale_fill_gradientn(colours = terrain.colors(7)) +
  geom_sf(data = ecoregions, color = "black", fill = NA) 

elevation_all_ecoregions_plot

```

```{r Reading in and cleaning OBA data, and plot of all 3 datasets}

OBA <- read.csv("OBA_2018-2023.csv")

# displaying unfiltered OBA data
head(OBA)


# cleaning OBA data to only include bee observations including genus & species 
## genus & species data, and columns for lat/long & state
OBA_clean <- OBA %>% 
  dplyr::select("Dec..Lat." , "Dec..Long.", "Species", "State") %>%
  rename(Latitude = Dec..Lat., Longitude = Dec..Long.) %>%
  filter(!is.na(Species) & Species != "") %>%
  dplyr::select("Latitude" , "Longitude", "Species", "State") %>% 

# excluding extraneous lat/long points that are outside of OR
  filter(!is.na(Longitude) & !is.na(Latitude)) %>%
  filter(Longitude > -125 & 
           Longitude < -116.5 & Latitude > -47 & Latitude < 47) %>%
  filter(Latitude != 39.98700) %>%
  filter(Latitude != 46.99) %>%
  filter(Longitude != -125.3831) %>%
  filter(Latitude != 41.680) %>%
  filter(Longitude != -116.464) %>%
  filter(State %in% c("Oregon ", "Oregon", "OR"))

# displaying filtered OBA data to just what we need
head(OBA_clean)


# converting OBA data to an sf object
OBA_sf <- st_as_sf(OBA_clean,
                          coords = c("Longitude","Latitude"),
                          crs = crs("EPSG:4326"))

# reprojecting OBA data to DEM crs
OBA_reprojected <- st_transform(OBA_sf, crs(dem_rast))


# displaying reprojected OBA data
head(OBA_reprojected)



# plot of all 3 data sets together
bee_points <- ggplot() +
  geom_sf(data = OBA_sf, size = 0.7, color = "black") 
  
bee_points

```



```{r Filling out OBA dataframe with elevation and ecoregion data}

# adding elevation column to OBA data
OBA_reprojected$Elevation <- terra::extract(dem_rast_downsampled, 
                                            OBA_reprojected, ID = FALSE)[[1]]

# distribution of elevations in oregon
hist(OBA_reprojected$Elevation)


# adding ecoregion column to oba data
template <- rast(vect(ecoregions), res = res(dem_rast_downsampled))

rast_ecoregions <- rasterize(vect(ecoregions), template, field = "Ecoregion")

OBA_reprojected$Ecoregion <- terra::extract(rast_ecoregions, 
                                            OBA_reprojected, ID = FALSE)[[1]]


# turning filled out OBA data into df
OBA_reprojected_df <- as.data.frame(OBA_reprojected, xy=TRUE)

# filled out OBA df that shows the elevation and ecoregion that each
## species was observed in
head(OBA_reprojected_df)

```




```{r Code for calculating TVD}

# splitting elevation into 4 bins within ecoregions 
OBA_reprojected_wBreaks <- OBA_reprojected %>%
  group_by(Ecoregion) %>%
  mutate(
    ElevationBin = cut(
      Elevation, 
      breaks = 4,
      include.lowest = TRUE))

OBA_reprojected_wBreaks <- as.data.frame(OBA_reprojected_wBreaks)

 
# removing NA elevation bins, and Nearshore ecoregion due to
## overlap issues with elevation data
OBA_binned <- OBA_reprojected_wBreaks %>%
  filter(!is.na(ElevationBin)) %>% 
  filter(!is.na(Ecoregion)) %>% 
  filter(Ecoregion != "Nearshore")


# creating column for observed richness
OBA_binned$Ecoregion <- as.character(OBA_binned$Ecoregion)

observed_richness <- OBA_binned %>%
     group_by(ElevationBin, Ecoregion) %>%
  summarize(BeeSpeciesRichness = length(unique(Species)))

#displaying OBA df with elevation bins
head(OBA_binned)


# creating a list of data frames, each containing data for an ecoregion
sp_occ <- split(OBA_binned, OBA_binned$Ecoregion)


# function to calculate TVD
calc_tvd <- function(observed, null) {

  observed_dist <- observed / sum(observed) 
  null_dist <- null / sum(null)             
  tvd <- 0.5 * sum(abs(observed_dist - null_dist))
  return(tvd)
}


# function for finding the TVD of all ecoregions
calculate_tvd_all_ecoregions <- function(species_occurence, observed=FALSE) {
  totalV <- list()
  if(observed == TRUE){
    for(ecoreg in 1:length(species_occurence)){
    observed_richness <- species_occurence[[ecoreg]] %>%
      group_by(ElevationBin) %>%
      summarize(
        BeeSpeciesRichness = length(unique(Species)))
    totalV[[ecoreg]] <- calc_tvd(observed_richness$BeeSpeciesRichness, rep(0.25, length(observed_richness$BeeSpeciesRichness)))
    }
    names(totalV) <- names(species_occurence)
    totalV <- unlist(totalV, recursive=FALSE)
  }else{
    for(i in 1:length(species_occurence)){
      generated_richness <- species_occurence[[i]] %>%
        group_by(shuffled_ElevationBin) %>%
        summarize(
          shuffled_BeeSpeciesRichness = length(unique(Species)))
      totalV[[i]] <- calc_tvd(generated_richness$shuffled_BeeSpeciesRichness, 
                              rep(0.25, length(
                                generated_richness$shuffled_BeeSpeciesRichness)))
    }
    names(totalV) <- names(species_occurence)
    totalV <- unlist(totalV, recursive = FALSE)
  }
  return(totalV)
}

```


```{r Plotting all data sets together}

# plot of all 3 data sets together
final_map <- ggplot() +
  geom_raster(data = dem_rast_dsamp_df, aes(x = x, y = y, 
                                            fill = OR_DEM_10M_files)) +
  labs(fill = "Elevation in feet", x = "Longitude", y = "Latitude") +
  scale_fill_gradientn(colours = terrain.colors(7)) +
  geom_sf(data = ecoregions, color = "navy", fill = NA ,linewidth = 0.6) +
  geom_sf(data = OBA_sf, size = 0.5, color = "black", alpha = 0.4) +
  labs(caption = "Black points represent bee observations", 
       title = "Figure 1: Bee Observations across Elevations and Oregon Ecoregions") +
  theme(plot.caption = element_text(hjust = 0.5))

final_map

```



```{r Null distribution generation}

# Initialize list to store null distributions for each ecoregion

# Number of repetitions
reps <- 100
null_distributions <- matrix(NA, nrow=reps, ncol=length(sp_occ))
colnames(null_distributions) <- names(sp_occ)

for(i in 1:reps){
  shuffled_sp_occ <- list()
  for(n in 1:length(sp_occ)){
    shuffled_column <- sample(sp_occ[[n]]$ElevationBin, nrow(sp_occ[[n]]), replace = FALSE)
    new_sp_occ <- sp_occ[[n]]
    new_sp_occ$shuffled_ElevationBin <- shuffled_column
    shuffled_sp_occ[[n]] <- new_sp_occ
  }
  names(shuffled_sp_occ) <- names(sp_occ)
  null_distributions[i,] <- calculate_tvd_all_ecoregions(shuffled_sp_occ) 
  
}
rownames(null_distributions)

library(tidyverse)
null_distributions <- as.data.frame(null_distributions)
long_null <- null_distributions %>%
  gather(key = "Ecoregion", value = "TVD")

#observed values
observed_tvd <- calculate_tvd_all_ecoregions(sp_occ, observed=TRUE) 
observed_tvd_df <- as.data.frame(observed_tvd)
colnames(observed_tvd_df) <- "TVD"
observed_tvd_df$Ecoregion <- row.names(observed_tvd_df)
row.names(observed_tvd_df) <- NULL

# displaying observed values
observed_tvd_df

# displaying some generated TVD values for the ecoregions (for null dist.)
head(null_distributions)


ecoregions <- intersect(unique(long_null$Ecoregion), unique(observed_tvd_df$Ecoregion))

  # Plot histograms with observed TVD lines
  histogram_plot <- ggplot(long_null, aes(x = TVD, fill = Ecoregion)) +
  geom_histogram(alpha = 0.6, bins = 30, position = "identity") +
  geom_vline(data = observed_tvd_df, aes(xintercept = TVD, color = Ecoregion), 
             linewidth = 1, color = "black") +
  facet_wrap(~ Ecoregion, scales = "free") +
  labs(
    title = "Figure 2: Null Distributions of TVD with Observed TVD Lines by Ecoregion",
    x = "TVD",
    y = "Frequency"
  ) +
  theme_minimal() +
  theme(legend.position = "none")

histogram_plot

```



```{r function for p values}

obs_null_distributions <- rbind(observed_tvd, null_distributions)

p_value_all_eco <- function(column){
 p <- mean(column[-1] >= column[1])  
 return(p)
}

p_values <- apply(obs_null_distributions, 2, p_value_all_eco)

# displaying p values for each ecoregion, looks like all are (very) significant!
p_values

```



```{r bar plot of observed}

# Getting unique ecoregions
ecoregions_for_plot <- unique(observed_richness$Ecoregion)

# Looping through each ecoregion and create a separate plot
for (eco in ecoregions_for_plot) {
  # Filter the data for the current ecoregion
  eco_data <- observed_richness %>% filter(Ecoregion == eco)
  
  # Creating the plot for the current ecoregion
  eco_plot <- ggplot(eco_data, aes(x = ElevationBin, y = BeeSpeciesRichness, 
                                   fill = ElevationBin)) +
    geom_bar(stat = "identity", show.legend = FALSE, width = 0.5) +
    labs(
      title = paste(" Figure 3: Species Richness Across Elevation Bins for", eco),
      x = "Elevation Bin (ft)",
      y = "Species Richness"
    ) +
    scale_fill_manual(values = c("lightpink", "lightblue", "darkseagreen4", 
                                 "mediumorchid")) +
    theme_minimal() + 
    theme(
      axis.text.x = element_text(size = 14, angle = 25, hjust = 1), 
      axis.title.x = element_text(size = 16), 
      strip.text = element_text(size = 16),
      axis.title.y = element_text(size = 16),
      plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
    )
  print(eco_plot)
}   

```



```{r Table showing data for total observations, richness and diversity}

# count total bee species per ecoregion
total_bee_table <- OBA_binned %>%
  group_by(Ecoregion) %>%          
  summarise(total_bee_species = n())  

# Count unique Species names per ecoregion
species_count <- OBA_binned %>%
  group_by(Ecoregion) %>%                                  
  summarise(unique_count = n_distinct(Species))       

unique(OBA_binned$Species)

total_unique_bee <- total_bee_table %>%
  left_join(species_count, by = "Ecoregion")


total_unique_bee <- total_unique_bee %>%
  mutate(ProportionUnique = (unique_count / total_bee_species)*100)


total_unique_bee

```
---
title: "Untitled"
output: html_document
date: "2024-11-13"
---

```{r setup, include=FALSE}
# packages that will be used
library(sf)
library(terra) 
library(ggplot2)
library(dplyr)
library(ggspatial)
library(tmap)
library(RColorBrewer)
library(raster)
```





```{r - Random stuff that may be useful later}
#gdb_file <- "C:/Users/Admin/Downloads/OR_DEM_10M.gdb/OR_DEM_10M.gdb/a00000029.gdbtable"
#layers <- st_layers(gdb_file)
#print(layers)

#gdb_data <- st_read(dsn = gdb_file, layer = "fras_blk_DEM_10meter_Oregon")


#head(gdb_data)

# commented code below is for cropping the extent of the data, will show a smaller portion of the state rather than a reduced res version

#extent <- ext(dem_rast) * 0.01  # Crop to 1% of the original size
#dem_rast_subset <- crop(dem_rast, extent)

# Convert the subset to a data frame
#dem_rast_df <- as.data.frame(dem_rast_subset, xy = TRUE)
#dem_rast_df <- as.data.frame(dem_rast, xy = TRUE)
#dem_rast_df

#gdb_path <- "C:/Users/Admin/Downloads/OR_DEM_10M_files.gdb"
#raster <- rast("C:/Users/Admin/Downloads/OR_DEM_10M_files.gdb")
#raster
#layers <- terra::sources(gdb_path)
```





```{r - Code for reading in a reducing resolution of DEM data}

describe("C:/Users/Admin/Downloads/OR_DEM_10M_files.gdb")
dem_rast <- rast("C:/Users/Admin/Downloads/OR_DEM_10M_files.gdb")
dem_rast

dem_rast_downsampled <- aggregate(dem_rast, fact = 100, fun = mean)
dem_rast_dsamp_df <- as.data.frame(dem_rast_downsampled, xy = TRUE)

head(dem_rast_dsamp_df)
summary(values(dem_rast_downsampled))

#save downsampled rast as .rdata file, then send to Kate  

```




```{r Reading in ecoregion data and plot of elevation and ecoregions}

ecoregions_vec <- st_read("C:/Users/Admin/Downloads/ds-environ-JS/5-lab-OR-fires/5-OR-fires/OR-ecoregions/Ecoregions_OregonConservationStrategy.shp")
head(ecoregions_vec)
#st_crs(dem_rast_downsampled)
crs(ecoregions_vec, proj = TRUE)
crs(dem_rast_downsampled, proj = TRUE)
ecoregions <- st_transform(ecoregions_vec, crs(dem_rast))
#st_crs(ecoregions)
head(ecoregions)
#elevation_crop <- crop(x = dem_rast_downsampled, y = ecoregions)
#elevation_crop_df <- as.data.frame(elevation_crop, xy= TRUE)

elevation_all_ecoregions_plot <- ggplot() +
  geom_raster(data = dem_rast_dsamp_df, aes(x = x, y = y, fill = OR_DEM_10M_files)) +
  scale_fill_viridis_c() +
  geom_sf(data = ecoregions, color = "black", fill = NA) 

elevation_all_ecoregions_plot

```
```{r Stuff for matching extent - doesn't work correctly}

# trying to crop the extent of the raster data so that it fits completely into the ecoregions data, but 
## neither of the below seem to work

#ecoregions_vec <- st_crop(ecoregions_vec, st_bbox(dem_rast_downsampled))
#dem_rast_downsampled <- crop(dem_rast_downsampled, st_bbox(ecoregions_vec))

# commented code below is something I found online for matching the extents of both data sets, results are weird

# names(ecoregions_vec)
crs(dem_rast_downsampled, proj = TRUE)
crs(ecoregions_vec, proj = TRUE)
# ext(dem_rast_downsampled)
# ext(ecoregions_vec)
# 
# aligned_raster <- resample(dem_rast_downsampled, rast(ecoregions_vec), method = "bilinear") 
# 
# ext(aligned_raster)

#align_dem_rast_df <- as.data.frame(aligned_raster, xy = TRUE)
#align_dem_rast_df

#elevation_all_ecoregions_plot <- ggplot() +
  #geom_raster(data = align_dem_rast_df, aes(x = x, y = y, fill = OR_DEM_10M_files)) +
  #scale_fill_gradientn(colours = terrain.colors(7)) +
  #geom_sf(data = ecoregions_vec, color = "black", fill = NA) 

#elevation_all_ecoregions_plot

```


```{r Splitting the ecoregions data into the separate ecoregions with elevation data}

# names(ecoregions_vec)
# crs(dem_rast_downsampled, proj = TRUE)
# crs(ecoregions_vec, proj = TRUE)
# ext(dem_rast_downsampled)
# ext
ecoregions_vec
minmax(dem_rast_downsampled)
st_crs(elevation_crop)
st_crs(ecoregions)

```

```{r Elevation data for ecoregion}

# filtering for single ecoregion, in this case the East Cascades
east_cascades <- ecoregions %>% filter(Ecoregion == "East Cascades")
print(east_cascades)


# extracting all elevation values (each pixel is 1 km since the data was decreased in res 100X from original 10x10m pixel size)
## for the specific ecoregion
#Ecas <- extract(x = dem_rast_downsampled, y = east_cascades)
#print(Ecas)

# plot of the ecoregion highlighted on the entire OR ecoregions map
plot(st_geometry(ecoregions), col = "lightgrey", main = "East Cascades Ecoregion Highlighted")
plot(st_geometry(east_cascades), col = "blue", add = TRUE)

# cropping DEM raster to extent of east cascades
east_cascades_rast <- mask(dem_rast_downsampled, east_cascades)
east_cascades_df <- as.data.frame(east_cascades_rast, xy = TRUE)
print(east_cascades_df)


# histogram of elevation data for this ecoregion
# ggplot() +
#   geom_histogram(data = east_cascades_rast, aes(x = OR_DEM_10M_files)) +
#   xlab("elevation") +
#   ylab("sq. km")

OBA_reprojected <- st_transform(OBA_sf, crs(dem_rast))

?mask
ext(OBA_sf)

# cropping OBA data to east cascades extent
OBA_sf_ecas <- st_intersection(OBA_reprojected, east_cascades)

# plot of the ecoregion alone with its associated elevation data 
ggplot() +
  geom_raster(data = east_cascades_df, aes(x=x, y=y, fill = OR_DEM_10M_files)) +
  geom_point(aes(x = geometry.x, y = geometry.y, color = as.factor(OBA_reprojected_df$ElevationBin)), size = 3) +
  scale_color_viridis_d(name = "Elevation Bin") +  # Use a discrete color scale
  scale_fill_gradientn(colours = terrain.colors(7)) +
  geom_sf(data = east_cascades, color = "black", fill = NA) +
  geom_sf(data = OBA_sf_ecas, size = 0.8, color = "black", alpha = 0.2)

# OBA_sf_ecas$Elevation <- terra::extract(east_cascades_rast, OBA_sf_ecas, ID = FALSE)[[1]]
# head(bee_df)
# head(OBA_sf_ecas)

```




```{r Filling out OBA df with elevation and ecoregion for each bee observation}

# basically adding elevation column to oba data
OBA_reprojected$Elevation <- terra::extract(dem_rast_downsampled, OBA_reprojected, ID = FALSE)[[1]]

hist(OBA_reprojected$Elevation)


# adding ecoregion column to oba data
template <- rast(vect(ecoregions), res = res(dem_rast_downsampled))

rast_ecoregions <- rasterize(vect(ecoregions), template, field = "Ecoregion")

OBA_reprojected$Ecoregion <- terra::extract(rast_ecoregions, OBA_reprojected, ID = FALSE)[[1]]

plot(rast_ecoregions)
table(OBA_reprojected$Ecoregion)


# turning reprojected OBA data into df
OBA_reprojected_df <- as.data.frame(OBA_reprojected, xy=TRUE)



# adding in elevation bins - seems like this method doesn't work quite right
# since the border issues cause the ecoregions touching the edge of the 
# OBA_reprojected_df <- OBA_reprojected_df %>%
#   group_by(Ecoregion) %>%
#   mutate(
#     ElevationBin = cut(
#       Elevation, 
#       breaks = seq(min(Elevation), max(Elevation), length.out = 11), include.lowest = TRUE))

# this binning method works but sometimes gives 11 bins instead of 10 
OBA_reprojected_df <- OBA_reprojected_df %>%
  group_by(Ecoregion) %>%
  mutate(
    ElevationBin = cut(
      Elevation, 
      breaks = 10,
      include.lowest = TRUE))

OBA_reprojected_df
unique(OBA_reprojected_df$Ecoregion)



table(unique(OBA_reprojected_df$Ecoregion))
 

```




```{r reading in bee data and selecting OBA columns}

OBA <- read.csv("C:/Users/Admin/Downloads/ds-environ-JS/6_lab_OBA_spatial/6_OBA_spatial/OBA_2018-2023.csv")
head(OBA)


OBA_filtered <- OBA %>% 
  select("Dec..Lat." , "Dec..Long.", "Genus", "Species", "State") %>%
  rename(Latitude = Dec..Lat., Longitude = Dec..Long.) %>%
  mutate(GenusSpecies = paste(Genus, Species, sep = " ")) %>%
  filter(GenusSpecies != " ") %>%
  select("Latitude" , "Longitude","State", "GenusSpecies")

head(OBA_filtered)


```



```{r getting rid of na values and cleaning coordinates to only OR entries}

OBA_clean <- OBA_filtered %>%
  filter(!is.na(Longitude) & !is.na(Latitude)) %>%
  filter(Longitude > -125 & Longitude < -116.5 & Latitude > -47 & Latitude < 47) %>%
  filter(Latitude != 39.98700) %>%
  filter(Latitude != 46.99) %>%
  filter(Longitude != -125.3831) %>%
  filter(Latitude != 41.680) %>%
  filter(Longitude != -116.464) %>%
  filter(State %in% c("Oregon ", "Oregon", "OR"))

head(OBA_clean)

```




```{r, converting to sf}

OBA_sf <- st_as_sf(OBA_clean,
                          coords = c("Longitude","Latitude"),
                          crs = crs("EPSG:4326"))
head(OBA_sf)

OBA_sf

```








```{r, plotting OBA data}

#crs(ecoregions_OR, proj=TRUE)
#crs(OBA_sf)
#crs(dem_rast_downsampled, proj = TRUE)

crs("EPSG:4326")

# current_bbox <- st_bbox(bee_species_sp)
# print(current_bbox)
# 
# # Defining a new bounding box
# new_bbox <- st_bbox(c(xmin = -123.414, ymin = 41.998, xmax = -117.227, ymax = 45.868), crs = st_crs(bee_species_sp))
# 
# # Cropping to the new bounding box
# bee_data_cropped <- st_crop(bee_species_sp, new_bbox)
# 
# print(st_bbox(bee_data_cropped))

#cat(sort(unique(OBA_clean$Latitude)))
#cat(sort(unique(OBA_clean$Longitude)))

#mapping bee data
ggplot() +
  geom_sf(data = OBA_sf)
```


```{r}

ext(ecoregions_vec)
ext(bee_data_cropped)
ext(dem_rast)

crs(ecoregions_vec)
crs(bee_data_cropped)
crs(dem_rast)


# bee_data_reprojected <- st_transform(bee_data_cropped, crs = 2992)
# 
# # DEM extent as SpatExtent
# dem_extent <- ext(dem_rast_downsampled)
# 
# # Convert SpatExtent to an sf polygon
# dem_extent_sf <- st_as_sf(as.polygons(dem_extent, crs = crs(dem_rast_downsampled)))
# 
# # Ensure the bee data and DEM extent are in the same CRS
# bee_data_cropped <- st_transform(bee_data_cropped, crs(dem_extent_sf))
# 
# bee_data_clipped <- st_intersection(bee_data_cropped, dem_extent_sf)

# OBA_sf <- st_transform(OBA_sf, crs(dem_rast_downsampled), res=res(dem_rast_downsampled))
# 
# OBA_sf_rast <- mask(dem_rast_downsampled, OBA_sf)
# OBA_df <- as.data.frame(OBA_sf_rast, xy = TRUE)

ggplot() +
  geom_raster(data = dem_rast_dsamp_df, aes(x = x, y = y, fill = OR_DEM_10M_files)) +
  labs(fill = "Elevation in feet") +
  scale_fill_gradientn(colours = terrain.colors(7)) +
  geom_sf(data = ecoregions, color = "black", fill = NA) +
  geom_sf(data = OBA_sf, size = 0.8, color = "black", alpha = 0.2)

```
```{r Creating df that includes bee observations, coordinates, ecoregion and elevation}

?mask



```

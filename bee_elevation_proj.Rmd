---
title: "Untitled"
output: html_document
date: "2024-11-13"
---

```{r setup, include=FALSE}
# packages that will be used
library(sf)
library(terra) 
library(ggplot2)
library(dplyr)
library(ggspatial)
library(tmap)
library(RColorBrewer)
library(raster)
```





```{r - Random stuff that may be useful later}
#gdb_file <- "C:/Users/Admin/Downloads/OR_DEM_10M.gdb/OR_DEM_10M.gdb/a00000029.gdbtable"
#layers <- st_layers(gdb_file)
#print(layers)

#gdb_data <- st_read(dsn = gdb_file, layer = "fras_blk_DEM_10meter_Oregon")


#head(gdb_data)

# commented code below is for cropping the extent of the data, will show a smaller portion of the state rather than a reduced res version

#extent <- ext(dem_rast) * 0.01  # Crop to 1% of the original size
#dem_rast_subset <- crop(dem_rast, extent)

# Convert the subset to a data frame
#dem_rast_df <- as.data.frame(dem_rast_subset, xy = TRUE)
#dem_rast_df <- as.data.frame(dem_rast, xy = TRUE)
#dem_rast_df

#gdb_path <- "C:/Users/Admin/Downloads/OR_DEM_10M_files.gdb"
#raster <- rast("C:/Users/Admin/Downloads/OR_DEM_10M_files.gdb")
#raster
#layers <- terra::sources(gdb_path)


#crs(ecoregions_OR, proj=TRUE)
#crs(OBA_sf)
#crs(dem_rast_downsampled, proj = TRUE)

#crs("EPSG:4326")

# current_bbox <- st_bbox(bee_species_sp)
# print(current_bbox)
# 
# # Defining a new bounding box
# new_bbox <- st_bbox(c(xmin = -123.414, ymin = 41.998, xmax = -117.227, ymax = 45.868), crs = st_crs(bee_species_sp))
# 
# # Cropping to the new bounding box
# bee_data_cropped <- st_crop(bee_species_sp, new_bbox)
# 
# print(st_bbox(bee_data_cropped))

#cat(sort(unique(OBA_clean$Latitude)))
#cat(sort(unique(OBA_clean$Longitude))
```





```{r - Code for reading in a reducing resolution of DEM data}

describe("C:/Users/Admin/Downloads/OR_DEM_10M_files.gdb")
dem_rast <- rast("C:/Users/Admin/Downloads/OR_DEM_10M_files.gdb")
dem_rast

dem_rast_downsampled <- aggregate(dem_rast, fact = 100, fun = mean)
dem_rast_dsamp_df <- as.data.frame(dem_rast_downsampled, xy = TRUE)

head(dem_rast_dsamp_df)
summary(values(dem_rast_downsampled))

#save downsampled rast as .rdata file, then send to Kate  

```




```{r Reading in ecoregion data and plot of elevation and ecoregions}

ecoregions_vec <- st_read("C:/Users/Admin/Downloads/ds-environ-JS/5-lab-OR-fires/5-OR-fires/OR-ecoregions/Ecoregions_OregonConservationStrategy.shp")
head(ecoregions_vec)

crs(ecoregions_vec, proj = TRUE)
crs(dem_rast_downsampled, proj = TRUE)

# changing ecoregion crs to dem crs
ecoregions <- st_transform(ecoregions_vec, crs(dem_rast))


elevation_all_ecoregions_plot <- ggplot() +
  geom_raster(data = dem_rast_dsamp_df, aes(x = x, y = y, fill = OR_DEM_10M_files)) +
  scale_fill_viridis_c() +
  geom_sf(data = ecoregions, color = "white", fill = NA) 

elevation_all_ecoregions_plot

```

```{r getting rid of na values and cleaning coordinates to only OR entries}

OBA <- read.csv("C:/Users/Admin/Downloads/ds-environ-JS/6_lab_OBA_spatial/6_OBA_spatial/OBA_2018-2023.csv")
head(OBA)
names(OBA)

OBA_filtered <- OBA %>% 
  dplyr::select("Dec..Lat." , "Dec..Long.", "Genus", "Species", "State") %>%
  rename(Latitude = Dec..Lat., Longitude = Dec..Long.) %>%
  mutate(GenusSpecies = paste(Genus, Species, sep = " ")) %>%
  filter(GenusSpecies != " ") %>%
  dplyr::select("Latitude" , "Longitude", "GenusSpecies", "State")

head(OBA_filtered)

OBA_clean <- OBA_filtered %>%
  filter(!is.na(Longitude) & !is.na(Latitude)) %>%
  filter(Longitude > -125 & Longitude < -116.5 & Latitude > -47 & Latitude < 47) %>%
  filter(Latitude != 39.98700) %>%
  filter(Latitude != 46.99) %>%
  filter(Longitude != -125.3831) %>%
  filter(Latitude != 41.680) %>%
  filter(Longitude != -116.464) %>%
  filter(State %in% c("Oregon ", "Oregon", "OR"))

head(OBA_clean)

OBA_sf <- st_as_sf(OBA_clean,
                          coords = c("Longitude","Latitude"),
                          crs = crs("EPSG:4326"))
head(OBA_sf)

OBA_sf

OBA_reprojected <- st_transform(OBA_sf, crs(dem_rast))

class(OBA_reprojected)

```

```{r Filling out OBA df with elevation and ecoregion for each bee observation}

# basically adding elevation column to oba data
OBA_reprojected$Elevation <- terra::extract(dem_rast_downsampled, OBA_reprojected, ID = FALSE)[[1]]

hist(OBA_reprojected$Elevation)


# adding ecoregion column to oba data
template <- rast(vect(ecoregions), res = res(dem_rast_downsampled))

rast_ecoregions <- rasterize(vect(ecoregions), template, field = "Ecoregion")

OBA_reprojected$Ecoregion <- terra::extract(rast_ecoregions, OBA_reprojected, ID = FALSE)[[1]]

OBA_reprojected
plot(rast_ecoregions)
table(OBA_reprojected$Ecoregion)


# turning reprojected OBA data into df
OBA_reprojected_df <- as.data.frame(OBA_reprojected, xy=TRUE)
class(OBA_reprojected_df)


# adding in elevation bins - seems like this method doesn't work quite right
# since the border issues cause the ecoregions touching the edge of the 
# OBA_reprojected_df <- OBA_reprojected_df %>%
#   group_by(Ecoregion) %>%
#   mutate(
#     ElevationBin = cut(
#       Elevation, 
#       breaks = seq(min(Elevation), max(Elevation), length.out = 11), include.lowest = TRUE))


# this binning method works but sometimes gives 11 bins instead of 10 
OBA_reprojected_wBreaks <- OBA_reprojected %>%
  group_by(Ecoregion) %>%
  mutate(
    ElevationBin = cut(
      Elevation, 
      breaks = 10,
      include.lowest = TRUE))


# Get unique ecoregions with NA ElevationBin
unique_ecoregions_with_na <- unique(na_rows$Ecoregion)

# Display the ecoregions
table(unique_ecoregions_with_na)
 
# removing NA elevation bins
OBA_reprojected_wBreaks_clean <- OBA_reprojected_wBreaks %>%
  filter(!is.na(ElevationBin))

# Check the cleaned dataset
head(OBA_reprojected_wBreaks_clean)

sum(is.na(OBA_reprojected_wBreaks_clean$ElevationBin))

length(unique(OBA_reprojected_wBreaks_clean$ElevationBin[OBA_reprojected_wBreaks_clean$Ecoregion == "Coast Range"]))

range(OBA_reprojected_wBreaks_clean$Elevation)

levels(ElevationBin)

```

```{r}

# trying to figure out elevation binning issue

coast_range_data <- OBA_reprojected_wBreaks %>%
  filter(Ecoregion == "Coast Range")

# View the filtered data
print(coast_range_data)
unique(OBA_reprojected_wBreaks$Ecoregion)
sum(is.na(OBA_reprojected_wBreaks$Ecoregion))
 
as.data.frame(OBA_reprojected[is.na(OBA_reprojected$Ecoregion), ])

print(unique(OBA_reprojected_wBreaks$ElevationBin[OBA_reprojected_wBreaks$Ecoregion == "Columbia Plateau"]))


```









```{r Filling out OBA df with elevation and ecoregion for each bee observation}

# basically adding elevation column to oba data
OBA_reprojected$Elevation <- terra::extract(dem_rast_downsampled, OBA_reprojected, ID = FALSE)[[1]]

hist(OBA_reprojected$Elevation)


# adding ecoregion column to oba data
template <- rast(vect(ecoregions), res = res(dem_rast_downsampled))

rast_ecoregions <- rasterize(vect(ecoregions), template, field = "Ecoregion")

OBA_reprojected$Ecoregion <- terra::extract(rast_ecoregions, OBA_reprojected, ID = FALSE)[[1]]

plot(rast_ecoregions)
table(OBA_reprojected$Ecoregion)


# turning reprojected OBA data into df
OBA_reprojected_df <- as.data.frame(OBA_reprojected, xy=TRUE)



# adding in elevation bins - seems like this method doesn't work quite right
# since the border issues cause the ecoregions touching the edge of the 
# OBA_reprojected_df <- OBA_reprojected_df %>%
#   group_by(Ecoregion) %>%
#   mutate(
#     ElevationBin = cut(
#       Elevation, 
#       breaks = seq(min(Elevation), max(Elevation), length.out = 11), include.lowest = TRUE))

# this binning method works but sometimes gives 11 bins instead of 10 
OBA_reprojected_df <- OBA_reprojected_df %>%
  group_by(Ecoregion) %>%
  mutate(
    ElevationBin = cut(
      Elevation, 
      breaks = 10,
      include.lowest = TRUE))

OBA_reprojected_df
unique(OBA_reprojected_df$Ecoregion)



table(unique(OBA_reprojected_df$Ecoregion))
 

```



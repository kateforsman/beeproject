---
title: "Relationship Between Bee Richness and Elevation in Oregon
by Kate Forsman and Jared Schnider"
output: pdf_document
date: "2024-12-8"
---

Introduction

  The Pacific Northwest is an area with a diverse range of ecosystems. 
The ecosystems in this region are likely to experience dramatic changes due 
to the effects of climate change, given that a large portion of Oregon is 
highly susceptible to forest fires (Halofsky, et al., 2020).  Changing climate 
and extreme weather events are likely to change elevation preference in 
pollinators as well as impact bloom time in plants that they visit (USDA). 
Since pollinators are responsible for the majority of fruit and seed production,
it is vital that bee species diversity is maintained (Kearns & Oliveras, 2009). 
Oregon is home to approximately 500 different species of bee, as well as other 
types of pollinators such as ants and flies (USDA). Within the state, there are 
nine ecoregions that span a wide range of ecosystems, each hosting a diverse 
array of bees. Current research has examined the effects of factors such as 
climate, geography, and ecology on species diversity in bee populations. 
Research by Orr, et al. has found that the most prevalent drivers of diversity 
in bees were climate and non-forest plant productivity, with areas of a 
temperate climate and high plant species richness promoting higher diversity of 
bees (Orr, et al., 2021). Pollinator diversity plays an important role in 
maintaining natural plant communities, as pollinators provide a unique and 
essential ecosystem service that can not be effectively replicated through 
just increasing pollinator abundance (Katumo, et al., 2022). It is known 
that the presence of bees is heavily impacted by factors such as rainfall, 
temperature, and wind, as these factors determine the availability of floral 
resources, in turn affecting the foraging success of bees 
(Tennakoon, et al., 2024).
  
Currently, many studies have examined the effects of elevation in relation 
to bee species diversity. In the western US, researchers demonstrated that 
higher elevations led to increased genetic differentiation among montane 
bumblebee populations, driven by restricted gene flow in these environments 
Jackson et al., 2018). The study suggested that species with narrow elevational 
ranges are more vulnerable to habitat fragmentation and climate change, 
emphasizing the role of elevation in relation to genetic divergence. In the 
Eastern Afromontane Biodiversity Hotspot in Kenya, a decrease was observed in 
both species richness and abundance across communities with increasing 
elevation, linked to seasonal climate variations and shifts in floral 
resource availability that is predicted to become more extreme due to 
climate change (Dzekashu, et al., 2022). In contrast, a study performed in 
Central Java, Indonesia, found there to be a linear increase in bee species 
richness and abundance with increasing elevation, with species diversity 
peaking at middle elevations (Widhiono, et al., 2017). These contrasting 
results highlight the importance of not only elevation in regards to bee 
species diversity, but also other climatic factors that are associated with 
changes in elevation. 
	
The current body of literature encompasses a wide range of factors that 
impact bee species diversity, as well as diverse locations from around 
the world, showing that there are many intersecting components that impact 
bee species diversity. Our goal is to focus on the spatial components that 
impact bee species diversity, specifically elevation, within each ecoregion 
in the state of Oregon. 
  
The purpose of our study is to determine how bee species diversity is related 
to elevation within different ecoregions in Oregon. Our goal is to determine 
which ecoregion in Oregon has the highest diversity of bee species and if bee 
species richness follows an elevational gradient. We are interested in 
elucidating which of the nine ecoregions have the highest diversity of bees, 
and if species diversity in bees follows an elevational gradient within each 
ecoregion. We predict that Southeast Oregon, the Northern Basin and Range 
ecoregion, will have the highest diversity of bees due to the dry climate and 
varying elevation levels which can accommodate different species. Additionally, 
we predict that bees in Oregon will follow an elevational gradient, with lower 
elevation regions within ecoregion hosting a higher diversity of bee species.

References

Dzekashu, F. F., Yusuf, A. A., Pirk, C. W. W., Steffan‐Dewenter, I., Lattorff,
H. M. G., & Peters, M. K. (2022). 
Floral turnover and climate drive seasonal bee diversity along a tropical 
elevation gradient. Ecosphere, 13(3), e3964. 
https://doi.org/10.1002/ecs2.3964

Halofsky, J. E., Peterson, D. L., & Harvey, B. J. (2020). 
Changing wildfire, changing forests: The effects of climate change on fire 
regimes and vegetation in the Pacific Northwest, USA. Fire Ecology, 16(1), 4. 
https://doi.org/10.1186/s42408-019-0062-8

Jackson, J. M., Pimsler, M. L., Oyen, K. J., Koch‐Uhuad, J. B., Herndon, J. D.,
Strange, J. P., Dillon, M. E., & Lozier, J. D. (2018). 
Distance, elevation and environment as drivers of diversity and divergence in 
bumble bees across latitude and altitude. Molecular Ecology, 27(14), 2926–2942. 
https://doi.org/10.1111/mec.14735

Katumo, D. M., Liang, H., Ochola, A. C., Lv, M., Wang, Q.-F., & 
Yang, C.-F. (2022). 
Pollinator diversity benefits natural and agricultural ecosystems, 
environmental health, and human welfare. Plant Diversity, 44(5), 429–435. 
https://doi.org/10.1016/j.pld.2022.01.005

Kearns, C. A., & Oliveras, D. M. (2009). Environmental factors affecting 
bee diversity in urban and remote grassland plots in Boulder, Colorado. 
Journal of Insect Conservation, 13(6), 655–665. 
https://doi.org/10.1007/s10841-009-9215-4

Orr, M. C., Hughes, A. C., Chesters, D., Pickering, J., Zhu, 
C.-D., & Ascher, J. S. (2021). Global Patterns and Drivers of Bee Distribution. 
Current Biology, 31(3), 451-458.e4. 
https://doi.org/10.1016/j.cub.2020.10.053

Tennakoon, S., Apan, A., & Maraseni, T. (2024). Unravelling the impact of 
climate change on honey bees: An ensemble modelling approach to predict 
shifts in habitat suitability in Queensland, Australia. 
Ecology and Evolution, 14(4). 
https://doi.org/10.1002/ece3.1130

Widhiono, I., Sudiana, E., & Darsono, D. (2017). Diversity of Wild Bees along 
Elevational Gradient in an Agricultural Area in Central Java, Indonesia. 
Psyche: A Journal of Entomology, 2017, 1–5. 
https://doi.org/10.1155/2017/2968414

Northwest Pollinators and Climate Change | USDA Climate Hubs. (n.d.). 
https://www.climatehubs.usda.gov/hubs/northwest/topic/northwest-pollinators-
and-climate-change

Data 

In our project, we used the Oregon Bee Atlas, Oregon Ecoregion data set, 
and a Digital Elevation Model of Oregon (links to data sets below). 
The Ecoregions data set was found on the Oregon Spatial Data Library website. 
Every ecoregion, other than the Nearshore, are from the Oregon Biodiversity 
Information Center (ORBIC) March, 2010 ecoregion dataset. The Nearshore 
ecoregion was from the Oregon State Boundary dataset, provided via the Oregon 
GEOSpatial Data Library. To create the nine ecoregions, jurisdictional 
boundaries were used to ensure every region was divided properly. There are 
seven columns in the dataset, with the first four identifying the ecoregion by 
Object ID, name, abbreviation, and code. The next two columns are both forms of 
GIS data that represent the area and perimeter of each ecoregion. The final 
column states the geometry of each region as polygons and also includes 
coordinates. As for the Digital Elevation Model of Oregon (DEM) the raster 
data was found on GEOHub and was created by the Oregon Department of 
Forestry. The original resolution of the DEM is 10x10 meters, with the 
elevation recorded in feet. The DEM was created as a floating point raster, 
rather than an integer. Both data sets were too large to upload to github, 
so they will need to be downloaded from the links below for use.

DEM: https://www.arcgis.com/home/item.html?id=b2a1742f015744d2bc619e5e59c00330

Ecoregions data: 
https://spatialdata.oregonexplorer.info/geoportal/
details;id=3c7862c4ae664993ad1531907b1e413e


```{r setup, include=FALSE}
# packages that will be used
library(sf)
library(terra) 
library(ggplot2)
library(dplyr)
library(ggspatial)
library(tmap)
library(RColorBrewer)
library(raster)
```
  
Data Wrangling & Summarizing

The following code will read in and filter our data. There are descriptions
for what each section is accomplishing, with added notations for chunks of 
code. Some initial tables, graphs, and dataset summaries are used to
get a better understanding of our data set. Final visualizations can be found
in figures 1, 2, and table 1 (total_unique_bee) at the end of our code.


```{r - Code for reading in and reducing resolution of DEM data}

describe("~/Downloads/dem_rast_r.tif")
dem_rast <- rast("~/Downloads/dem_rast_r.tif")
dem_rast

dem_rast_downsampled <- aggregate(dem_rast, fact = 100, fun = mean)
dem_rast_dsamp_df <- as.data.frame(dem_rast_downsampled, xy = TRUE)

# initial data exploration of DEM
head(dem_rast_dsamp_df)
summary(values(dem_rast_downsampled))

```



```{r Reading in ecoregion data and plot of elevation and ecoregions}

ecoregions_vec <- st_read("~/Downloads/5-OR-fires/OR-ecoregions")
head(ecoregions_vec)

crs(ecoregions_vec, proj = TRUE)
crs(dem_rast_downsampled, proj = TRUE)

# changing ecoregion crs to dem crs
ecoregions <- st_transform(ecoregions_vec, crs(dem_rast))

# cool plot of elevation and ecoregion data together
elevation_all_ecoregions_plot <- ggplot() +
  geom_raster(data = dem_rast_dsamp_df, aes(x = x, y = y, fill = OR_DEM_10M_files)) +
  scale_fill_gradientn(colours = terrain.colors(7)) +
  geom_sf(data = ecoregions, color = "black", fill = NA) 

elevation_all_ecoregions_plot

```




```{r Reading in and cleaning OBA data, and plot of all 3 datasets}

OBA <- read.csv("~/Downloads/6_OBA_spatial/OBA_2018-2023.csv")

# displaying unfiltered OBA data
head(OBA)


# cleaning OBA data to only include bee observations including genus & species 
## genus & species data, and columns for lat/long & state
OBA_clean <- OBA %>% 
  dplyr::select("Dec..Lat." , "Dec..Long.", "Species", "State") %>%
  rename(Latitude = Dec..Lat., Longitude = Dec..Long.) %>%
  filter(!is.na(Species) & Species != "") %>%
  dplyr::select("Latitude" , "Longitude", "Species", "State") %>% 

# excluding extraneous lat/long points that are outside of OR
  filter(!is.na(Longitude) & !is.na(Latitude)) %>%
  filter(Longitude > -125 & 
           Longitude < -116.5 & Latitude > -47 & Latitude < 47) %>%
  filter(Latitude != 39.98700) %>%
  filter(Latitude != 46.99) %>%
  filter(Longitude != -125.3831) %>%
  filter(Latitude != 41.680) %>%
  filter(Longitude != -116.464) %>%
  filter(State %in% c("Oregon ", "Oregon", "OR"))

# displaying filtered OBA data to just what we need
head(OBA_clean)


# converting OBA data to an sf object
OBA_sf <- st_as_sf(OBA_clean,
                          coords = c("Longitude","Latitude"),
                          crs = crs("EPSG:4326"))

# reprojecting OBA data to DEM crs
OBA_reprojected <- st_transform(OBA_sf, crs(dem_rast))


# displaying reprojected OBA data
head(OBA_reprojected)



# plot of all 3 data sets together
bee_points <- ggplot() +
  geom_sf(data = OBA_sf, size = 0.7, color = "black") 
  
bee_points

```



```{r Filling out OBA dataframe with elevation and ecoregion data}

# adding elevation column to OBA data
OBA_reprojected$Elevation <- terra::extract(dem_rast_downsampled, 
                                            OBA_reprojected, ID = FALSE)[[1]]

# distribution of elevations in oregon
hist(OBA_reprojected$Elevation)


# adding ecoregion column to oba data
template <- rast(vect(ecoregions), res = res(dem_rast_downsampled))

rast_ecoregions <- rasterize(vect(ecoregions), template, field = "Ecoregion")

OBA_reprojected$Ecoregion <- terra::extract(rast_ecoregions, 
                                            OBA_reprojected, ID = FALSE)[[1]]


# turning filled out OBA data into df
OBA_reprojected_df <- as.data.frame(OBA_reprojected, xy=TRUE)

# filled out OBA df that shows the elevation and ecoregion that each
## species was observed in
head(OBA_reprojected_df)

```




```{r Code for calculating TVD}

# splitting elevation into 4 bins within ecoregions 
OBA_reprojected_wBreaks <- OBA_reprojected %>%
  group_by(Ecoregion) %>%
  mutate(
    ElevationBin = cut(
      Elevation, 
      breaks = 4,
      include.lowest = TRUE))

OBA_reprojected_wBreaks <- as.data.frame(OBA_reprojected_wBreaks)

 
# removing NA elevation bins, and Nearshore ecoregion due to
## overlap issues with elevation data
OBA_binned <- OBA_reprojected_wBreaks %>%
  filter(!is.na(ElevationBin)) %>% 
  filter(!is.na(Ecoregion)) %>% 
  filter(Ecoregion != "Nearshore")


# creating column for observed richness
OBA_binned$Ecoregion <- as.character(OBA_binned$Ecoregion)

observed_richness <- OBA_binned %>%
     group_by(ElevationBin, Ecoregion) %>%
  summarize(BeeSpeciesRichness = length(unique(Species)))

#displaying OBA df with elevation bins
head(OBA_binned)


# creating a list of data frames, each containing data for an ecoregion
sp_occ <- split(OBA_binned, OBA_binned$Ecoregion)


# function to calculate TVD
calc_tvd <- function(observed, null) {

  observed_dist <- observed / sum(observed) 
  null_dist <- null / sum(null)             
  tvd <- 0.5 * sum(abs(observed_dist - null_dist))
  return(tvd)
}


# function for finding the TVD of all ecoregions
calculate_tvd_all_ecoregions <- function(species_occurence, observed=FALSE) {
  totalV <- list()
  if(observed == TRUE){
    for(ecoreg in 1:length(species_occurence)){
    observed_richness <- species_occurence[[ecoreg]] %>%
      group_by(ElevationBin) %>%
      summarize(
        BeeSpeciesRichness = length(unique(Species)))
    totalV[[ecoreg]] <- calc_tvd(observed_richness$BeeSpeciesRichness, rep(0.25, length(observed_richness$BeeSpeciesRichness)))
    }
    names(totalV) <- names(species_occurence)
    totalV <- unlist(totalV, recursive=FALSE)
  }else{
    for(i in 1:length(species_occurence)){
      generated_richness <- species_occurence[[i]] %>%
        group_by(shuffled_ElevationBin) %>%
        summarize(
          shuffled_BeeSpeciesRichness = length(unique(Species)))
      totalV[[i]] <- calc_tvd(generated_richness$shuffled_BeeSpeciesRichness, 
                              rep(0.25, length(
                                generated_richness$shuffled_BeeSpeciesRichness)))
    }
    names(totalV) <- names(species_occurence)
    totalV <- unlist(totalV, recursive = FALSE)
  }
  return(totalV)
}

```


```{r Plotting all data sets together}

# plot of all 3 data sets together
final_map <- ggplot() +
  geom_raster(data = dem_rast_dsamp_df, aes(x = x, y = y, 
                                            fill = OR_DEM_10M_files)) +
  labs(fill = "Elevation in feet", x = "Longitude", y = "Latitude") +
  scale_fill_gradientn(colours = terrain.colors(7)) +
  geom_sf(data = ecoregions, color = "navy", fill = NA ,linewidth = 0.6) +
  geom_sf(data = OBA_sf, size = 0.5, color = "black", alpha = 0.4) +
  labs(caption = "Black points represent bee observations", 
       title = "Figure 1: Bee Observations across Elevations and Oregon Ecoregions") +
  theme(plot.caption = element_text(hjust = 0.5))

final_map

```


```{r Null distribution generation}

# Initialize list to store null distributions for each ecoregion

# Number of repetitions
reps <- 100
null_distributions <- matrix(NA, nrow=reps, ncol=length(sp_occ))
colnames(null_distributions) <- names(sp_occ)

for(i in 1:reps){
  shuffled_sp_occ <- list()
  for(n in 1:length(sp_occ)){
    shuffled_column <- sample(sp_occ[[n]]$ElevationBin, nrow(sp_occ[[n]]), replace = FALSE)
    new_sp_occ <- sp_occ[[n]]
    new_sp_occ$shuffled_ElevationBin <- shuffled_column
    shuffled_sp_occ[[n]] <- new_sp_occ
  }
  names(shuffled_sp_occ) <- names(sp_occ)
  null_distributions[i,] <- calculate_tvd_all_ecoregions(shuffled_sp_occ) 
  
}
rownames(null_distributions)

library(tidyverse)
null_distributions <- as.data.frame(null_distributions)
long_null <- null_distributions %>%
  gather(key = "Ecoregion", value = "TVD")

#observed values
observed_tvd <- calculate_tvd_all_ecoregions(sp_occ, observed=TRUE) 
observed_tvd_df <- as.data.frame(observed_tvd)
colnames(observed_tvd_df) <- "TVD"
observed_tvd_df$Ecoregion <- row.names(observed_tvd_df)
row.names(observed_tvd_df) <- NULL

# displaying observed values
observed_tvd_df

# displaying some generated TVD values for the ecoregions (for null dist.)
head(null_distributions)


ecoregions <- intersect(unique(long_null$Ecoregion), unique(observed_tvd_df$Ecoregion))

  # Plot histograms with observed TVD lines
  histogram_plot <- ggplot(long_null, aes(x = TVD, fill = Ecoregion)) +
  geom_histogram(alpha = 0.6, bins = 30, position = "identity") +
  geom_vline(data = observed_tvd_df, aes(xintercept = TVD, color = Ecoregion), 
             linewidth = 1, color = "black") +
  facet_wrap(~ Ecoregion, scales = "free") +
  labs(
    title = "Figure 2: Null Distributions of TVD with Observed TVD Lines by Ecoregion",
    x = "TVD",
    y = "Frequency"
  ) +
  theme_minimal() +
  theme(legend.position = "none")

histogram_plot

```



```{r function for p values}

obs_null_distributions <- rbind(observed_tvd, null_distributions)

p_value_all_eco <- function(column){
 p <- mean(column[-1] >= column[1])  
 return(p)
}

p_values <- apply(obs_null_distributions, 2, p_value_all_eco)

# displaying p values for each ecoregion, looks like all are (very) significant!
p_values

```

Hypothesis Test

From our results, we can conclude that there is a relationship between 
elevation and bee species richness within each ecoregion. This is reflected 
in the figure 2, as the histograms show our observed total variation distance 
testing (TVD) value to be far outside of our generated null distributions. 
Our p values also indicate significance as there were no null distributions 
generated that the observed value fell within (p=0). We can also conclude that 
Columbia Plateau ecoregion has the highest diversity 
(measured as relative species richness) at 8.3%.


```{r bar plot of observed}

# Getting unique ecoregions
ecoregions_for_plot <- unique(observed_richness$Ecoregion)

# Looping through each ecoregion and create a separate plot
for (eco in ecoregions_for_plot) {
  # Filter the data for the current ecoregion
  eco_data <- observed_richness %>% filter(Ecoregion == eco)
  
  # Creating the plot for the current ecoregion
  eco_plot <- ggplot(eco_data, aes(x = ElevationBin, y = BeeSpeciesRichness, 
                                   fill = ElevationBin)) +
    geom_bar(stat = "identity", show.legend = FALSE, width = 0.5) +
    labs(
      title = paste(" Figure 3: Species Richness Across Elevation Bins for", eco),
      x = "Elevation Bin (ft)",
      y = "Species Richness"
    ) +
    scale_fill_manual(values = c("lightpink", "lightblue", "darkseagreen4", 
                                 "mediumorchid")) +
    theme_minimal() + 
    theme(
      axis.text.x = element_text(size = 14, angle = 25, hjust = 1), 
      axis.title.x = element_text(size = 16), 
      strip.text = element_text(size = 16),
      axis.title.y = element_text(size = 16),
      plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
    )
  print(eco_plot)
}   

```



```{r Table showing data for total observations, richness and diversity}

# count total bee species per ecoregion
total_bee_table <- OBA_binned %>%
  group_by(Ecoregion) %>%          
  summarise(total_bee_species = n())  

# Count unique Species names per ecoregion
species_count <- OBA_binned %>%
  group_by(Ecoregion) %>%                                  
  summarise(unique_count = n_distinct(Species))       

total_unique_bee <- total_bee_table %>%
  left_join(species_count, by = "Ecoregion")


total_unique_bee <- total_unique_bee %>%
  mutate(ProportionUnique = (unique_count / total_bee_species)*100)


total_unique_bee

```

Conclusion

The ecoregion with the most species diversity is the Columbia Plateau. 
(Figure 1, Table 1). The ecoregion consists entirely of lowlands, is 
dominated by shrubs and grasses, and has an arid climate with hot summers 
and cold winters. These conditions are ideal for various bee species due to 
the warm, dry weather and large amount of flowering plants which can be 
used for foraging. The Willamette Valley ecoregion has the highest total bee 
observation count (18,600) but lowest relative species richness at 1.0%. This 
can be attributed to the heavily urbanized areas and agricultural land that 
make up this ecoregion, causing habitat loss and fragmentation. Based on the 
results of the TVD test, the null hypothesis, that each elevation bin has the 
same number of unique species, can be rejected since the observed TVD is far 
outside the null TVD distribution and the p-value for each ecoregion was found 
to be zero (Figure 2). Additionally, the observed species richness for each 
elevation bin shows different elevational preferences for unique bee species 
(Figure 3). Overall, our testing showed that different bee species in Oregon 
require specific elevations and ecoregions to thrive. However, elevation and 
ecoregion preferences may shift due to changing climate from natural disasters, 
such as forest fires, and human activities, such as increased urbanization, 
which could alter their habitats.

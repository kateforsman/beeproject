---
title: "Untitled"
output: html_document
date: "2024-11-13"
---

```{r setup, include=FALSE}
# packages that will be used
library(sf)
library(terra) 
library(ggplot2)
library(dplyr)
library(ggspatial)
#library(tmap)
library(RColorBrewer)

```



```{r - Code for reading in a reducing resolution of DEM data}

describe("~/Downloads/dem_rast_r.tif")
dem_rast <- rast("~/Downloads/dem_rast_r.tif")
crs(dem_rast)

dem_rast_downsampled <- aggregate(dem_rast, fact = 100, fun = mean)
dem_rast_dsamp_df <- as.data.frame(dem_rast_downsampled, xy = TRUE)
head(dem_rast_dsamp_df)
summary(values(dem_rast_downsampled))
plot(dem_rast_downsampled)


```




```{r Reading in ecoregion data and plot of elevation and ecoregions}

ecoregions_vec <- st_read("~/Downloads/5-OR-fires/OR-ecoregions")
head(ecoregions_vec)
class(ecoregions_vec)
#st_crs(dem_rast_downsampled)
class(dem_rast_downsampled)

#st_crs(dem_rast_downsampled)
#st_crs(ecoregions_vec)
ecoregions <- st_transform(ecoregions_vec, crs(dem_rast_downsampled), res=res(dem_rast_downsampled))
#st_crs(ecoregions)
head(ecoregions)
#elevation_crop <- crop(x = dem_rast_downsampled, y = ecoregions)
#elevation_crop_df <- as.data.frame(elevation_crop, xy= TRUE)

elevation_all_ecoregions_plot <- ggplot() +
  geom_raster(data = dem_rast_dsamp_df, aes(x = x, y = y, fill = OR_DEM_10M_files)) +
  scale_fill_gradientn(colours = terrain.colors(7)) +
  geom_sf(data = ecoregions, color = "black", fill = NA) 

elevation_all_ecoregions_plot

```
```{r Stuff for matching extent - doesn't work correctly}

crs(dem_rast_downsampled, proj = TRUE)
crs(ecoregions_vec, proj = TRUE)

```


```{r Splitting the ecoregions data into the separate ecoregions with elevation data}

ecoregions_vec
minmax(dem_rast_downsampled)
st_crs(ecoregions)

```



```{r reading in bee data and selecting OBA columns}

OBA <- read.csv("~/Downloads/6_OBA_spatial/OBA_2018-2023.csv")
head(OBA)

OBA_filtered <- OBA %>%
  select("Dec..Lat." , "Dec..Long.", "Species", "State") %>%
  rename(Latitude = Dec..Lat., Longitude = Dec..Long.) %>%
  filter(!is.na(Species) & Species != "")

OBA_filtered
```



```{r, getting rid of na values and cleaning latitdue}
 
OBA_clean <- OBA_filtered %>%
  filter(!is.na(Longitude) & !is.na(Latitude)) %>%
  filter(Longitude > -125 & Longitude < -116.5 & Latitude > -47 & Latitude < 47) %>%
  filter(Latitude != 39.98700) %>%
  filter(Latitude != 46.99) %>%
  filter(Longitude != -125.3831) %>%
  filter(Latitude != 41.680) %>%
  filter(Longitude != -116.464) %>%
  filter(State %in% c("Oregon ", "Oregon", "OR"))

head(OBA_clean)

```



```{r, converting to sf}

OBA_sf <- st_as_sf(OBA_clean,
                          coords = c("Longitude","Latitude"),
                          crs = crs("EPSG:4326"))
head(OBA_sf)

OBA_sf

OBA_reprojected <- st_transform(OBA_sf, crs(dem_rast))

class(OBA_reprojected)

```



```{r Filling out OBA df with elevation and ecoregion for each bee observation}

# basically adding elevation column to oba data
OBA_reprojected$Elevation <- terra::extract(dem_rast_downsampled, OBA_reprojected, ID = FALSE)[[1]]

hist(OBA_reprojected$Elevation)


# adding ecoregion column to oba data
template <- rast(vect(ecoregions), res = res(dem_rast_downsampled))

rast_ecoregions <- rasterize(vect(ecoregions), template, field = "Ecoregion")

OBA_reprojected$Ecoregion <- terra::extract(rast_ecoregions, OBA_reprojected, ID = FALSE)[[1]]

OBA_reprojected
plot(rast_ecoregions)
table(OBA_reprojected$Ecoregion)


# turning reprojected OBA data into df
OBA_reprojected_df <- as.data.frame(OBA_reprojected, xy=TRUE)
class(OBA_reprojected_df)


# this binning method works
OBA_reprojected_wBreaks <- OBA_reprojected %>%
  group_by(Ecoregion) %>%
  mutate(
    ElevationBin = cut(
      Elevation, 
      breaks = 4,
      include.lowest = TRUE))

OBA_reprojected_wBreaks <- as.data.frame(OBA_reprojected_wBreaks)

OBA_reprojected_wBreaks
 
# removing NA elevation bins
OBA_reprojected_wBreaks_clean <- OBA_reprojected_wBreaks %>%
  filter(!is.na(ElevationBin)) %>% 
  filter(!is.na(Ecoregion)) %>% 
  filter(Ecoregion != "Nearshore")

OBA_reprojected_wBreaks_clean$Ecoregion <- as.character(OBA_reprojected_wBreaks_clean$Ecoregion)

# splitting to create list of data frames, each containing information for an ecoregion
sp_occ <- split(OBA_reprojected_wBreaks_clean, OBA_reprojected_wBreaks_clean$Ecoregion)
sp_occ
shuffled_sp_occ <- list()
for(i in 1:length(sp_occ)){
 shuffled_column <-sample(sp_occ[[i]]$ElevationBin, nrow(sp_occ[[i]]), replace = FALSE)
 new_sp_occ <- sp_occ[[i]]
 new_sp_occ$shuffled_ElevationBin <- shuffled_column
 shuffled_sp_occ[[i]] <- new_sp_occ
}

calc_tvd <- function(observed, null) {

  observed_dist <- observed / sum(observed) 
  null_dist <- null / sum(null)             
  tvd <- 0.5 * sum(abs(observed_dist - null_dist))
  return(tvd)
}

totalV <- list()

for(i in 1:length(shuffled_sp_occ)){
  observed_richness <- shuffled_sp_occ[[i]] %>%
  group_by(ElevationBin) %>%
  summarize(
    BeeSpeciesRichness = length(unique(Species)))
  
  generated_richness <- shuffled_sp_occ[[i]] %>%
  group_by(shuffled_ElevationBin) %>%
  summarize(
    shuffled_BeeSpeciesRichness = length(unique(Species)))
  colnames(generated_richness) <- c("ElevationBin", "shuffled_BeeSpeciesRichness")
  total_richness <- left_join(observed_richness, generated_richness)
 
  totalV[[i]] <- calc_tvd(total_richness$BeeSpeciesRichness,total_richness$shuffled_BeeSpeciesRichness)
  
}

names(total_richness) <- names(shuffled_sp_occ)
names(totalV) <- names(shuffled_sp_occ)
totalV
# makes TVD values a vector
unlist(totalV, recursive = FALSE)
totalV

names(total_richness) <- names(shuffled_sp_occ)
#total_richness["Willamette Valley"]


names(shuffled_sp_occ) <- names(sp_occ)

# df for each ecoregion - has shuffled and normal elevation bins
shuffled_sp_occ
shuffled_sp_occ[["Coast Range"]]
sp_occ[["Nearshore"]]
names(shuffled_sp_occ)

shuffled_Elevation <- sample(OBA_reprojected_wBreaks_clean$ElevationBin, nrow(OBA_reprojected_wBreaks_clean), replace = FALSE)
OBA_reprojected_wBreaks_clean$shuffled_ElevationBin <- shuffled_Elevation

OBA_reprojected_wBreaks_clean

class(sp_occ) 

sp_occ

```

```{r NUll distribution -- Kate}
#TVD calculation
calc_tvd <- function(observed, null) {
  observed_dist <- observed / sum(observed) 
  null_dist <- null / sum(null)             
  tvd <- 0.5 * sum(abs(observed_dist - null_dist))
  return(tvd)
}
#repetitions, empty list for null, emptry vector for observed
reps <- 100
null_tvd_list <- list()
observed_tvd <- numeric(length(sp_occ))
#loop through every ecoregion
for (i in 1:length(sp_occ)) {
  null_tvd <- numeric(reps)
  
  #calculate observed richnes 
  observed_richness <- sp_occ[[i]] %>%
    group_by(ElevationBin) %>%
    summarize(BeeSpeciesRichness = length(unique(Species)))
  
  # Compute observed TVD
  generated_richness <- shuffled_sp_occ[[i]] %>%
    group_by(shuffled_ElevationBin) %>%
    summarize(shuffled_BeeSpeciesRichness = length(unique(Species)))
  
  colnames(generated_richness) <- c("ElevationBin", "shuffled_BeeSpeciesRichness")
  total_richness <- left_join(observed_richness, generated_richness)
  observed_tvd[i] <- calc_tvd(
    total_richness$BeeSpeciesRichness,
    total_richness$shuffled_BeeSpeciesRichness
  )
  #repetitions to generate null
  for (j in 1:reps) {
    # Shuffle ElevationBin
    shuffled_column <- sample(sp_occ[[i]]$ElevationBin, nrow(sp_occ[[i]]), replace = FALSE)
    new_sp_occ <- sp_occ[[i]]
    new_sp_occ$shuffled_ElevationBin <- shuffled_column
    
    # Calculate richness based on shuffled ElevationBin
    generated_richness <- new_sp_occ %>%
      group_by(shuffled_ElevationBin) %>%
      summarize(shuffled_BeeSpeciesRichness = length(unique(Species)))
    
    colnames(generated_richness) <- c("ElevationBin", "shuffled_BeeSpeciesRichness")
    total_richness <- left_join(observed_richness, generated_richness)
    
    # Compute and store TVD for this shuffle
    null_tvd[j] <- calc_tvd(
      total_richness$BeeSpeciesRichness,
      total_richness$shuffled_BeeSpeciesRichness
    )
  }
  
  null_tvd_list[[i]] <- null_tvd # Store null TVD distribution for this ecoregion
}


null_tvd_df <- do.call(rbind, lapply(1:length(null_tvd_list), function(i) {
  data.frame(
    Ecoregion = names(sp_occ)[i],
    TVD = null_tvd_list[[i]],
    Type = "Null"
  )
}))

observed_tvd_df <- data.frame(
  Ecoregion = names(sp_occ),
  TVD = observed_tvd,
  Type = "Observed"
)

combined_tvd_df <- rbind(null_tvd_df, observed_tvd_df)

# Plot histogram for each ecoregion
histograms_for_eco <- ggplot(combined_tvd_df, aes(x = TVD, fill = Ecoregion)) +
  geom_histogram(data = subset(combined_tvd_df, Type == "Null"), bins = 40, alpha = 0.6) +
  geom_vline(data = subset(combined_tvd_df, Type == "Observed"), aes(xintercept = TVD, color = Type), linetype = "solid") +
  facet_wrap(~Ecoregion, scales = "free") +
  theme_minimal() +
  labs(
    title = "Total Variation Distance by Ecoregion: Null and Observed",
    x = "TVD",
    y = "Count",
    fill = "Ecoregion Null TVD" ,
    color = "Observed TVD"
  )

histograms_for_eco

```



```{r, pvalues -- Kate}

# Assuming the ecoregion names are in observed_tvd_df$Ecoregion
names(null_tvd_list) <- observed_tvd_df$Ecoregion

null_tvd_list

# Loop through each ecoregion
for (ecoregion_name in names(null_tvd_list)) {
  # Get the observed TVD for the current ecoregion
  observed_tvd <- observed_tvd_df$ObservedTVD[observed_tvd_df$Ecoregion == ecoregion_name]
  
  # Get the null distribution for the current ecoregion
  null_distribution <- null_tvd_list[[ecoregion_name]]
  
  # Calculate the p-value as the proportion of null values greater than or equal to the observed TVD
  p_value <- mean(null_distribution >= observed_tvd)
  
  # Store the p-value in the list
  p_values[[ecoregion_name]] <- p_value
}

# View the p-values for each ecoregion
p_values <- as.data.frame(p_values)
p_values


```


```{r, plotting OBA data}

cat(sort(unique(OBA_clean$Latitude)))
cat(sort(unique(OBA_clean$Longitude)))

#mapping bee data
ggplot() +
  geom_sf(data = OBA_sf)
```




```{r, final elevation/ecoregion/bee map}

final_map <- ggplot() +
  geom_raster(data = dem_rast_dsamp_df, aes(x = x, y = y, fill = OR_DEM_10M_files)) +
  labs(fill = "Elevation in feet", x = "Longitude", y = "Latitude") +
  scale_fill_gradientn(colours = terrain.colors(7)) +
  geom_sf(data = ecoregions, color = "black", fill = NA) +
  geom_sf(data = OBA_sf, size = 0.3, color = "black", alpha = 0.2) +
  labs(caption = "Figure 1. Black points represent bee observations", title = "Bee Observations across Elevations and Oregon Ecoregions") +
  theme(plot.caption = element_text(hjust = 0.5))

final_map

ggsave("beemap.png", final_map)

```





```{r, total and unique bee species, proportions}


# count total bee species per ecoregion
total_bee_table <- OBA_reprojected_wBreaks_clean %>%
  group_by(Ecoregion) %>%          # Group the data by the 'ecoregion' column
  summarise(total_bee_species = n())  # Summing the species 

# Count unique Species names per ecoregion
species_count <- OBA_reprojected_wBreaks_clean %>%
  group_by(Ecoregion) %>%                                  
  summarise(unique_count = n_distinct(Species))       

unique(OBA_reprojected_wBreaks_clean$Species)

# View the result
total_bee_table
species_count

total_unique_bee <- st_join(species_count, total_bee_table, by = "Ecoregion")
total_unique_bee

beespecies_proportion <- total_unique_bee %>%
  mutate(ProportionUnique = unique_count / total_bee_species)
beespecies_proportion

total_bee_table <- OBA_reprojected_wBreaks_clean %>%
  group_by(Ecoregion) %>%          # Group the data by the 'ecoregion' column
  summarise(
    total_bee_species = n(),          # Count of total observations
    unique_species_count = n_distinct(Species) # Count of unique species
  )

total_bee_table

```










